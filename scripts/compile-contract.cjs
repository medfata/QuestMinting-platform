const solc = require('solc');
const fs = require('fs');
const path = require('path');

// Read the contract source
const contractPath = path.join(__dirname, '..', 'contracts', 'QuestMint.sol');
const source = fs.readFileSync(contractPath, 'utf8');

// Prepare input for solc
const input = {
  language: 'Solidity',
  sources: {
    'QuestMint.sol': {
      content: source,
    },
  },
  settings: {
    optimizer: {
      enabled: true,
      runs: 200,
    },
    outputSelection: {
      '*': {
        '*': ['abi', 'evm.bytecode.object'],
      },
    },
  },
};

// Import callback to resolve OpenZeppelin imports
function findImports(importPath) {
  try {
    // Handle OpenZeppelin imports
    if (importPath.startsWith('@openzeppelin/')) {
      const ozPath = path.join(__dirname, '..', 'node_modules', importPath);
      return { contents: fs.readFileSync(ozPath, 'utf8') };
    }
    return { error: 'File not found' };
  } catch (e) {
    return { error: e.message };
  }
}

console.log('Compiling QuestMint.sol...');

// Compile
const output = JSON.parse(solc.compile(JSON.stringify(input), { import: findImports }));

// Check for errors
if (output.errors) {
  const errors = output.errors.filter(e => e.severity === 'error');
  if (errors.length > 0) {
    console.error('Compilation errors:');
    errors.forEach(e => console.error(e.formattedMessage));
    process.exit(1);
  }
  // Show warnings
  output.errors.filter(e => e.severity === 'warning').forEach(e => {
    console.warn('Warning:', e.message);
  });
}

// Extract contract data
const contract = output.contracts['QuestMint.sol']['QuestMint'];
const abi = contract.abi;
const bytecode = '0x' + contract.evm.bytecode.object;

console.log('Compilation successful!');
console.log('ABI entries:', abi.length);
console.log('Bytecode length:', bytecode.length);

// Generate TypeScript file
const tsContent = `/**
 * QuestMint Contract - Compiled ABI and Bytecode
 * Auto-generated by scripts/compile-contract.cjs
 * DO NOT EDIT MANUALLY
 */

export const QUEST_MINT_ABI = ${JSON.stringify(abi, null, 2)} as const;

export type QuestMintAbi = typeof QUEST_MINT_ABI;

export const QUEST_MINT_BYTECODE = '${bytecode}' as \`0x\${string}\`;
`;

// Write to lib/contracts
const outputPath = path.join(__dirname, '..', 'lib', 'contracts', 'QuestMint.ts');
fs.writeFileSync(outputPath, tsContent);

console.log('Written to:', outputPath);
